<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Mule GeoMail Example</title>

    <!-- disable browser caching -->
    <META Http-Equiv="Cache-Control" Content="no-cache">
    <META Http-Equiv="Pragma" Content="no-cache">
    <META Http-Equiv="Expires" Content="0">

    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAcTrmTRvh52rxtw3y8IgnthSYzJDncC4j-i7Wh1gnESPNeNQc3RQuy8abrZ0QthJB5sUArjNozATZCw"
            type="text/javascript"></script>
    <!-- are using dojo functionality beyond cometd, lets make the full library available -->
    <script type="text/javascript" src="http://o.aolcdn.com/dojo/1.3.0/dojo/dojo.xd.js.uncompressed.js"></script>
    <script type="text/javascript" src="ibeans/js/ibeans.js"></script>

    <script type="text/javascript">

        /* create ibeans client with RPC disabled */
        var ibeans = new IBeansClient(false);

        var CONFIG = {
            center: new GLatLng(22.268764, 17.226563),
            zoomLevel: 2,
            mapType: G_HYBRID_MAP
        }

        var GeoMail;

        var map;

        var MapUtils = {

            createMarker: function(email)
            {
                console.debug("Email: " + email.latitude + ", " + email.longitude)
                var marker = new GMarker(new GLatLng(email.latitude, email.longitude));

                GEvent.addListener(marker, "click", function()
                {
                    marker.openInfoWindowHtml("<b>" + email.locationName + ", " + email.countryName + "</b><br/>Lat: "
                            + email.latitude + "&nbsp;Lon:" + email.longitude + "<br/>Email: " + email.email + "<br/>IP: " + email.ip);
                });
                return marker;
            }
        }


        function loadMap()
        {
            if (GBrowserIsCompatible())
            {
                GeoMail = new function()
                {
                    this.map = new GMap2(dojo.byId('mapview'));
                    this.map.setCenter(CONFIG.center, CONFIG.zoomLevel, CONFIG.mapType);

                    this.addEmail = function(email)
                    {

                        var marker = MapUtils.createMarker(email);
                        this.map.addOverlay(marker);

                    }
                }
            }
        }
    </script>
    <script type="text/javascript">

        function init()
        {
            loadMap();
            document.getElementById('area').innerHTML = "Subscribing...";
            ibeans.addReceiver("/GEOMAIL", receive);
            document.getElementById('area').innerHTML = "Listening..."
        }

        function dispose()
        {
            document.getElementById('area').innerHTML = "Unsubscribing...";
            ibeans.removeReceiver("/GEOMAIL", receive);
            ibeans.dispose();
        }

        receive = function(message)
        {
            console.debug("Recevid: " + message.data);
            document.getElementById('area').innerHTML = "RECEIVED";
            var data = message.data;

            if (data)
            {
                var sender = ibeans.fromJson(data);

                try
                {
                    console.debug("Adding sender: " + sender);
                    GeoMail.addEmail(sender);
                }
                catch (e)
                {
                    alert(content + ",\n" + e);
                }
            }
        }
    </script>

</head>
<body onload="init()" onunload="dispose()">

<h2>Mule GeoMail Example</h2>

<div id="mapview" style="width: 1000px; height: 500px"></div>
<div id="area">EMPTY</div>

</body>
</html>